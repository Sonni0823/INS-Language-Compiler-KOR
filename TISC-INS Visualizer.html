<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TISC-INS Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap');
        
        body { font-family: 'Fira Code', monospace; background-color: #1e1e1e; color: #d4d4d4; }
        
        .memory-cell {
            transition: background-color 0.1s;
            border: 1px solid #333;
        }
        .memory-cell.dp { background-color: #d97706 !important; border-color: #f59e0b; z-index: 10; }
        
        /* 값이 바뀔 때의 시각적 효과 */
        .memory-cell.changed { background-color: #ffffff !important; color: #000 !important; transition: none; }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }

        /* 터미널 출력 효과 */
        .terminal-text {
            color: #4ade80; /* green-400 */
            text-shadow: 0 0 5px rgba(74, 222, 128, 0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-[#252526] p-4 flex justify-between items-center border-b border-[#333]">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-green-400">TISC-INS <span class="text-gray-400 text-sm">Visualizer</span></h1>
            <div class="flex items-center gap-2 bg-[#333] px-3 py-1 rounded">
                <span class="text-xs text-gray-400">Speed:</span>
                <input type="range" id="speedRange" min="1" max="255" value="1" class="w-48 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                <span id="speedDisplay" class="text-xs font-bold text-yellow-400 w-12 text-right">1x</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="loadProgram()" id="btnLoad" class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-white text-sm">Compile</button>
            <button onclick="stepSingle()" class="bg-gray-600 hover:bg-gray-700 px-4 py-1 rounded text-white text-sm">Step (F10)</button>
            <button onclick="toggleRun()" id="btnRun" class="bg-green-600 hover:bg-green-700 px-4 py-1 rounded text-white text-sm">Run (F5)</button>
            <button onclick="reset()" class="bg-red-600 hover:bg-red-700 px-4 py-1 rounded text-white text-sm">Reset</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="w-1/3 flex flex-col border-r border-[#333]">
            <div class="p-2 bg-[#252526] text-xs font-bold uppercase tracking-wider flex justify-between">
                <span>Source Code (.ins)</span>
                <span class="text-gray-500">I, N, S only</span>
            </div>
            <textarea id="sourceCode" class="flex-1 bg-[#1e1e1e] p-4 text-sm resize-none outline-none border-none text-gray-300" 
                placeholder="INS Code Here..." spellcheck="false">
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I 
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I 
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I 
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I 
N
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I 
N
N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N N 
I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I 
</textarea>
            <div class="h-2/5 border-t border-[#333] flex flex-col">
                <div class="p-2 bg-[#252526] text-xs font-bold uppercase tracking-wider">Machine State</div>
                <div class="p-4 space-y-3 text-sm font-mono overflow-y-auto">
                    <div class="flex justify-between border-b border-gray-700 pb-1">
                        <span class="text-gray-500">Program Counter (pc):</span> 
                        <span id="valPC" class="text-blue-400 font-bold">0</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-1">
                        <span class="text-gray-500">Data Pointer (p):</span> 
                        <span id="valDP" class="text-orange-400 font-bold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Data @ p:</span> 
                        <span id="valData" class="text-green-400 font-bold">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-2/3 flex flex-col bg-[#1e1e1e]">
            
            <div class="h-2/3 flex flex-col overflow-hidden border-b border-[#333]">
                <div class="p-2 bg-[#252526] flex justify-between items-center">
                    <span class="text-xs font-bold uppercase tracking-wider">Data Tape (Length=256 Circular Tape)</span>
                    <div class="text-xs space-x-3 flex items-center">
                        <div class="flex items-center"><span class="inline-block w-3 h-3 bg-[#d97706] mr-1 rounded-sm"></span>Pointer</div>
                        <div class="flex items-center"><span class="inline-block w-3 h-3 bg-red-500 mr-1 rounded-sm"></span>Halt(T[0]=255)</div>
                    </div>
                </div>
                <div id="memoryGrid" class="flex-1 p-4 grid grid-cols-8 sm:grid-cols-12 gap-2 overflow-y-auto content-start"></div>
            </div>

            <div class="flex-1 flex flex-col bg-black">
                <div class="p-2 bg-[#333] text-xs font-bold uppercase tracking-wider text-gray-300 flex justify-between">
                    <span>Terminal Output (Result)</span>
                    <span class="text-[10px] text-gray-500">Reads T[1]... until 0 when Halted</span>
                </div>
                <div id="terminalOutput" class="flex-1 p-4 font-mono text-sm overflow-y-auto whitespace-pre-wrap terminal-text"></div>
            </div>

            <div class="h-24 border-t border-[#333] flex flex-col bg-[#111]">
                <div class="p-1 bg-[#252526] text-[10px] font-bold uppercase tracking-wider text-gray-400">System Log</div>
                <div id="opHistory" class="flex-1 p-2 font-mono text-gray-500 text-[10px] overflow-y-auto whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>

    <script>
        // --- INS Virtual Machine ---
        const TAPE_SIZE = 256; 
        let dataTape = new Uint8Array(TAPE_SIZE);
        let programTape = [];
        let pc = 0;
        let dp = 0;
        
        let isRunning = false;
        let animationFrameId = null;

        const elGrid = document.getElementById('memoryGrid');
        const elSource = document.getElementById('sourceCode');
        const elPC = document.getElementById('valPC');
        const elDP = document.getElementById('valDP');
        const elData = document.getElementById('valData');
        const elHistory = document.getElementById('opHistory');
        const elSpeed = document.getElementById('speedRange');
        const elSpeedDisplay = document.getElementById('speedDisplay');
        const elTerminal = document.getElementById('terminalOutput');

        // Speed Control (1x ~ 255x)
        let instructionsPerFrame = 1;

        elSpeed.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            instructionsPerFrame = val; // Linear Mapping
            elSpeedDisplay.innerText = instructionsPerFrame + "x";
        });

        function init() {
            renderFullGrid();
            updateStatus();
        }

        function log(msg) {
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            elHistory.appendChild(line);
            elHistory.scrollTop = elHistory.scrollHeight;
        }

        function renderFullGrid() {
            elGrid.innerHTML = '';
            for (let i = 0; i < TAPE_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = 'memory-cell bg-[#2d2d2d] p-1 text-xs font-mono flex flex-col justify-center items-center h-10 rounded';
                cell.id = `cell-${i}`;
                
                let labelColor = "text-gray-600";
                let label = i;
                if(i === 0) { label = "HALT"; labelColor = "text-red-500 font-bold"; }
                if(i === 1) { label = "OUT"; labelColor = "text-green-500 font-bold"; }

                cell.innerHTML = `
                    <span class="${labelColor} text-[10px]">${label}</span>
                    <span class="text-white font-bold value text-sm">${dataTape[i]}</span>
                `;
                elGrid.appendChild(cell);
            }
            highlightPointer();
        }

        function updateCellDOM(addr) {
            const cell = document.getElementById(`cell-${addr}`);
            if (cell) {
                cell.querySelector('.value').innerText = dataTape[addr];
                cell.classList.add('changed');
                if (instructionsPerFrame < 10) {
                    setTimeout(() => cell.classList.remove('changed'), 200);
                } else {
                    cell.classList.remove('changed'); 
                }
            }
        }

        function highlightPointer() {
            const old = document.querySelector('.dp');
            if (old) old.classList.remove('dp');
            
            const cell = document.getElementById(`cell-${dp}`);
            if (cell) {
                cell.classList.add('dp');
                if (instructionsPerFrame < 50) {
                    cell.scrollIntoView({ behavior: 'auto', block: 'nearest' });
                }
            }
        }

        function updateStatus() {
            elPC.innerText = pc;
            elDP.innerText = dp;
            elData.innerText = dataTape[dp];
        }

        function loadProgram() {
            stop();
            const raw = elSource.value;
            programTape = [];
            for(let char of raw) {
                if("insINS".includes(char)) {
                    programTape.push(char.toUpperCase());
                }
            }
            
            dataTape.fill(0);
            pc = 0;
            dp = 0;
            elTerminal.innerText = ""; // Clear Output
            
            renderFullGrid();
            log(`Program Loaded. Length: ${programTape.length}`);
            updateStatus();
        }

        // --- Logic Execution ---
        function executeLogic() {
             if (programTape.length === 0) return false;
             
             // Check Halt Condition First
             if (dataTape[0] === 255) return false; 

             const instr = programTape[pc];
             let jumped = false;

             if (instr === 'I') {
                 dataTape[dp] = (dataTape[dp] + 1) & 0xFF;
             } else if (instr === 'N') {
                 dp = (dp + 1) % TAPE_SIZE;
             } else if (instr === 'S') {
                 if (dataTape[dp] === 0) {
                     pc = (pc + 2) % programTape.length;
                     jumped = true;
                 }
             }

             if (!jumped) {
                 pc = (pc + 1) % programTape.length;
             }
             return true; // Continue running
        }

        // --- Output Generation (Mimics C Compiler) ---
        function generateOutput() {
            let output = "";
            let ptr = 1; // Start from T[1]
            // Read until we hit 0 or end of tape (Visualizer limit 256)
            while (ptr < TAPE_SIZE && dataTape[ptr] !== 0) {
                let code = dataTape[ptr];
                let char = String.fromCharCode(code);
                output += char;
                ptr++;
            }
            
            if (output.length > 0) {
                elTerminal.innerText = output;
                log(`Output generated: "${output}"`);
            } else {
                elTerminal.innerText = "(No output data in T[1]...)";
            }
        }

        function stepSingle() {
            if(executeLogic()) {
                updateCellDOM(dp); 
                highlightPointer();
                updateStatus();
            } else {
                if (dataTape[0] === 255) {
                    log("Halted (T[0] == 255).");
                    generateOutput();
                }
            }
        }

        function toggleRun() {
            const btn = document.getElementById('btnRun');
            if (isRunning) {
                stop();
            } else {
                if (programTape.length === 0) loadProgram();
                isRunning = true;
                btn.innerText = "Pause";
                btn.classList.replace('bg-green-600', 'bg-orange-600');
                gameLoop();
            }
        }

        function stop() {
            isRunning = false;
            cancelAnimationFrame(animationFrameId);
            const btn = document.getElementById('btnRun');
            btn.innerText = "Run (F5)";
            btn.classList.replace('bg-orange-600', 'bg-green-600');
        }

        function gameLoop() {
            if (!isRunning) return;

            let stepsToRun = instructionsPerFrame;
            let running = true;
            
            for(let i=0; i<stepsToRun; i++) {
                running = executeLogic();
                if(!running) break;
            }

            // Batch UI Update
            if (instructionsPerFrame > 100) {
                 renderFullGrid(); 
            } else {
                 updateCellDOM(dp);
                 highlightPointer();
            }
            updateStatus();

            if (!running) {
                log(`Halted. T[0] == 255`);
                generateOutput(); // Show "Hello World"
                stop();
                return;
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function reset() {
            stop();
            dataTape.fill(0);
            pc = 0;
            dp = 0;
            elTerminal.innerText = "";
            renderFullGrid();
            log("Reset.");
            updateStatus();
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'F10') { e.preventDefault(); stepSingle(); }
            if (e.key === 'F5') { e.preventDefault(); toggleRun(); }
        });

        init();
        
        // Auto-load example for demo
        loadProgram();
    </script>
</body>
</html>